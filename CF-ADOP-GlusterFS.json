{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Adop Core Generation 5 CloudFormation 0.2.7 - Advanced Version",
  "Mappings": {
    "RegionMap": {
      "eu-central-1": {
        "CENTOSAMI": "ami-9bf712f4",
        "AWSLINUXAMI": "ami-ea26ce85",
        "NATAMI": "ami-ae380eb3",
        "RHELAMI": "ami-875042eb"
      },
      "eu-west-1": {
        "CENTOSAMI": "ami-7abd0209",
        "AWSLINUXAMI": "ami-f9dd458a",
        "NATAMI": "ami-14913f63",
        "RHELAMI": "ami-8b8c57f8"
      },
      "us-east-1": {
        "CENTOSAMI": "ami-6d1c2007",
        "AWSLINUXAMI": "ami-6869aa05",
        "NATAMI": "ami-184dc970",
        "RHELAMI": "ami-2051294a"
      },
      "us-west-2": {
        "CENTOSAMI": "ami-d2c924b2",
        "AWSLINUXAMI": "ami-7172b611",
        "NATAMI": "ami-290f4119",
        "RHELAMI": "ami-775e4f16"
      },
      "us-west-1": {
        "CENTOSAMI": "ami-af4333cf",
        "AWSLINUXAMI": "ami-31490d51",
        "NATAMI": "ami-a98396ec",
        "RHELAMI": "ami-d1315fb1"
      },
      "ap-southeast-1": {
        "CENTOSAMI": "ami-f068a193",
        "AWSLINUXAMI": "ami-a59b49c6",
        "NATAMI": "ami-6aa38238",
        "RHELAMI": "ami-e0c19f83"
      },
      "ap-southeast-2": {
        "CENTOSAMI": "ami-fedafc9d",
        "AWSLINUXAMI": "ami-dc361ebf",
        "NATAMI": "ami-893f53b3",
        "RHELAMI": "ami-e0c19f83"
      },
      "ap-northeast-1": {
        "CENTOSAMI": "ami-eec1c380",
        "AWSLINUXAMI": "ami-374db956",
        "NATAMI": "ami-27d6e626",
        "RHELAMI": "ami-e0c19f83"
      },
      "ap-northeast-2": {
        "CENTOSAMI": "ami-c74789a9",
        "AWSLINUXAMI": "ami-2b408b45",
        "NATAMI": "ami-68a46f06",
        "RHELAMI": "ami-e0c19f83"
      },
      "sa-east-1": {
        "CENTOSAMI": "ami-26b93b4a",
        "AWSLINUXAMI": "ami-6dd04501",
        "NATAMI": "ami-8122969c",
        "RHELAMI": "ami-e0c19f83"
      }
    }
  },
  "Outputs": {
    "PublicDNSAcess": {
      "Description": "Main access point - Please copy this URL into your web browser.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "ProxyElasticLoadBalancer",
                "DNSName"
              ]
            }
          ]
        ]
      }
    },
    "PublicIpAccess": {
      "Description": "Alternative access point - Please copy this URL into your web browser. The ip address changes if this server reboots.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "OuterProxyEC2",
                "PublicIp"
              ]
            }
          ]
        ]
      }
    },
    "SSH": {
      "Description": "Use this command to ssh into your ADOP Outer Proxy instance.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "ssh -i ",
            {
              "Ref": "KeyName"
            },
            " ec2-user@",
            {
              "Fn::GetAtt": [
                "OuterProxyEC2",
                "PublicIp"
              ]
            },
            ""
          ]
        ]
      }
    },
    "OuterProxyPrivateIP": {
      "Description": "The Nginx Proxy EC2 instance private IP address.",
      "Value": {
        "Fn::GetAtt": [
          "OuterProxyEC2",
          "PrivateIp"
        ]
      }
    },
    "AdopEc2PrivateIP": {
      "Description": "The ADOP EC2 instance private IP address.",
      "Value": {
        "Fn::GetAtt": [
          "AdopEC2",
          "PrivateIp"
        ]
      }
    },
    "AdopPlatformCredentials": {
      "Description": "View this file inside the Adop EC2 instance backend to see the platform auto generated passwords.",
      "Value": "/adop/adop-docker-compose/platform.secrets.sh"
    }
  },
  "Parameters": {
    "AdopWorkspace": {
      "Default": "None",
      "Description": "Initialise a Jenkins workspace folder.",
      "Type": "String"
    },
    "AdopUsername": {
      "Default": "",
      "Description": "ADOP admin account username.",
      "Type": "String"
    },
    "AdopUserPassword": {
      "NoEcho": "true",
      "Description": "ADOP admin account password. Example allowed password: n0tyourusername123",
      "Type": "String",
      "MinLength": "8",
      "MaxLength": "15",
      "ConstraintDescription": "You are not allowed to include your 'username' or 'password' in your password! Minimum Length of 8 characters and must contain a number."
    },
    "KeyName": {
      "Default": "",
      "Description": "SSH Key pair for accessing your EC2 instance",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "EC2VolumeSize": {
      "Type": "String",
      "Default": "100",
      "Description": "ADOP Core EC2 volume size in GB."
    },
    "EC2InstanceType": {
      "Type": "String",
      "Description": "ADOP Core EC2 HVM instance type.",
      "AllowedValues": [
        "t2.large",
        "m4.large",
        "m4.xlarge",
        "m3.large",
        "m3.xlarge"
      ],
      "ConstraintDescription": "Must be a valid EC2 HVM instance type.",
      "Default": "m4.xlarge"
    }
  },
  "Resources": {
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": {
          "Ref": "Vpc"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "77d8a590-a4b7-4657-ae49-2bace7b74166"
        }
      }
    },
    "PublicRouteDefault": {
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "VpcInternetGateway"
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        }
      },
      "Type": "AWS::EC2::Route",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "cc4ce313-df1f-42d2-bab5-12efccd9dfd9"
        }
      }
    },
    "PublicRouteTable": {
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::RouteTable",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "4ddb3c75-e8a0-4b89-9744-115cc2a9d1ee"
        }
      }
    },
    "PublicSubnet": {
      "Properties": {
        "CidrBlock": "10.10.1.0/24",
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::Subnet",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3"
        }
      }
    },
    "PublicSubnetPublicRouteTableAssoc": {
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        },
        "SubnetId": {
          "Ref": "PublicSubnet"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "49ba56df-a6f9-4eef-a621-d01f453e23d9"
        }
      }
    },
    "Vpc": {
      "Properties": {
        "CidrBlock": "10.10.0.0/16",
        "EnableDnsHostnames": "true",
        "EnableDnsSupport": "true"
      },
      "Type": "AWS::EC2::VPC",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a44e677b-c679-482b-929c-f1a7aa112926"
        }
      }
    },
    "VpcGatewayAttachment": {
      "Properties": {
        "InternetGatewayId": {
          "Ref": "VpcInternetGateway"
        },
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "82dcb3af-1538-44be-b9ad-cda2335288f1"
        }
      }
    },
    "VpcInternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a25e58c0-2ee7-41d4-ab1f-42f4d636c535"
        }
      }
    },
    "AdopWaitCondition": {
      "Type": "AWS::CloudFormation::WaitCondition",
      "Properties": {
        "Handle": {
          "Ref": "AdopWaitConditionHandle"
        },
        "Timeout": "3500"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0eef5043-0727-47d5-8591-648eaf4ca05a"
        }
      },
      "DependsOn": [
        "AdopEC2"
      ]
    },
    "AdopWaitConditionHandle": {
      "Type": "AWS::CloudFormation::WaitConditionHandle",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7934e36f-378a-4447-aa93-674ae8a35be6"
        }
      }
    },
    "PrivateRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "c48aeab8-eb45-4a74-a89a-8688260aae5d"
        }
      }
    },
    "PrivateRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0a40d0ca-3581-4835-9597-e946ea1df989"
        }
      }
    },
    "PrivateSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "CidrBlock": "10.10.2.0/24",
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "47a0f538-656e-497c-9a80-fbc052fccd00"
        }
      }
    },
    "OuterProxyEC2": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "SourceDestCheck": "false",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": 20,
              "VolumeType": "gp2"
            }
          }
        ],
        "NetworkInterfaces": [
          {
            "AssociatePublicIpAddress": "true",
            "DeleteOnTermination": "true",
            "DeviceIndex": "0",
            "GroupSet": [
              {
                "Ref": "OuterProxySG"
              },
              {
                "Ref": "DockerApiSG"
              }
            ],
            "SubnetId": {
              "Ref": "PublicSubnet"
            }
          }
        ],
        "InstanceType": "t2.micro",
        "ImageId": {
          "Fn::FindInMap": [
            "RegionMap",
            {
              "Ref": "AWS::Region"
            },
            "AWSLINUXAMI"
          ]
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "OuterProxyEC2"
                ]
              ]
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "sleep 5\n",
                "IP=$(hostname -i)\n",
                "yum -y install docker\n",
                "sed -i \"s#OPTIONS=.*#OPTIONS='-H tcp://0.0.0.0:2377 -H unix:///var/run/docker.sock --default-ulimit nofile=1024:4096'#\" /etc/sysconfig/docker\n",
                "curl -L https://github.com/docker/compose/releases/download/1.7.1/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose\n",
                "chmod +x /usr/local/bin/docker-compose && ln -sv /usr/local/bin/docker-compose /usr/bin/docker-compose\n",
                "service docker start\n",
                "chkconfig docker on\n",
                "curl -X PUT -H 'Content-Type:' --data-binary '{\"Status\" : \"SUCCESS\",",
                "\"Reason\" : \"NAT Instance is ready\",",
                "\"UniqueId\" : \"IDNAT\",",
                "\"Data\" : \"Done\"}' ",
                "\"",
                {
                  "Ref": "NatWaitConditionHandle"
                },
                "\"\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a2c90913-332c-4f4c-a123-63d38abeed7e"
        }
      }
    },
    "AdopEC2": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvdf",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": {
                "Ref": "EC2VolumeSize"
              },
              "VolumeType": "gp2"
            }
          }
        ],
        "NetworkInterfaces": [
          {
            "AssociatePublicIpAddress": "false",
            "DeleteOnTermination": "true",
            "DeviceIndex": "0",
            "GroupSet": [
              {
                "Ref": "ToolsSG"
              },
              {
                "Ref": "MailServerSG"
              },
              {
                "Ref": "DockerApiSG"
              },
              {
                "Ref": "AllPortsSG"
              }
            ],
            "SubnetId": {
              "Ref": "PrivateSubnet"
            }
          }
        ],
        "InstanceType": {
          "Ref": "EC2InstanceType"
        },
        "ImageId": {
          "Fn::FindInMap": [
            "RegionMap",
            {
              "Ref": "AWS::Region"
            },
            "AWSLINUXAMI"
          ]
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "AdopEC2"
                ]
              ]
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "cat > /etc/yum.repos.d/glusterfs-epel.repo <<-EOF\n",
                "[glusterfs-epel]\n",
                "name=GlusterFS is a clustered file-system capable of scaling to several petabytes.\n",
                "baseurl=http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.0/EPEL.repo/epel-6/\\$basearch/\n",
                "enabled=1\n",
                "skip_if_unavailable=1\n",
                "gpgcheck=1\n",
                "gpgkey=http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.0/EPEL.repo/pub.key\n",
                "\n",
                "[glusterfs-noarch-epel]\n",
                "name=GlusterFS is a clustered file-system capable of scaling to several petabytes.\n",
                "baseurl=http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.0/EPEL.repo/epel-6/noarch\n",
                "enabled=1\n",
                "skip_if_unavailable=1\n",
                "gpgcheck=1\n",
                "gpgkey=http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.0/EPEL.repo/pub.key\n",
                "\n",
                "[glusterfs-source-epel]\n",
                "name=GlusterFS is a clustered file-system capable of scaling to several petabytes. - Source\n",
                "baseurl=http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.0/EPEL.repo/epel-6/SRPMS\n",
                "enabled=0\n",
                "skip_if_unavailable=1\n",
                "gpgcheck=1\n",
                "gpgkey=http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.0/EPEL.repo/pub.key\n",
                "\n",
                "EOF\n",
                "yum install -y glusterfs-fuse\n",
                "GLUSTER_SERVER_PRIVATE_IP=",
                {
                  "Fn::GetAtt": [
                    "GlusterServerEC2",
                    "PrivateIp"
                  ]
                },
                "\n",
                "mkdir -p /tools-gfs-vol1\n",
                "mount -t glusterfs ${GLUSTER_SERVER_PRIVATE_IP}:/tools-gfs-vol1 /tools-gfs-vol1\n",
                "echo \"${GLUSTER_SERVER_PRIVATE_IP}:/tools-gfs-vol1  /tools-gfs-vol1 glusterfs defaults 0 0 \" >> /etc/fstab\n",
                "export IP=$(hostname --ip-address)\n",
                "until [[ $(rpm -qa docker | wc -l) -gt 0 ]]; do yum -y install docker; echo \"Waiting until docker is installed..\"; sleep 5; done\n",
                "sed -i \"s#OPTIONS=.*#OPTIONS='-H tcp://0.0.0.0:2377 -H unix:///var/run/docker.sock --default-ulimit nofile=1024:4096'#\" /etc/sysconfig/docker\n",
                "yum -y install docker-storage-setup.noarch\n",
                "cat <<EOF > /etc/sysconfig/docker-storage-setup\n",
                "DEVS=/dev/xvdf\n",
                "VG=docker-vg\n",
                "EOF\n",
                "rm -fr /var/lib/docker\n",
                "docker-storage-setup\n",
                "service docker start\n",
                "chkconfig docker on\n",
                "curl -L https://github.com/docker/compose/releases/download/1.7.1/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose\n",
                "chmod +x /usr/local/bin/docker-compose && ln -sv /usr/local/bin/docker-compose /usr/bin/docker-compose\n",
                "yum -y install git\n",
                "mkdir /adop && cd /adop\n",
                "git clone https://github.com/AccenturePDC/adop-docker-compose.git -b pdc-ext\n",
                "chmod -R 700 /adop/adop-docker-compose\n",
                "cd /adop/adop-docker-compose\n",
                "mkdir -p conf/provider/aws\n",
                "sleep 10\n",
                "echo \"\n",
                "export SMTP_DOMAIN=amazonaws.com\n",
                "export ADOP_HOME=\"/adop/adop-docker-compose\"\n",
                "export GIT_REPO=gitlab\n",
                "export PUBLIC_IP=",
                {
                  "Fn::GetAtt": [
                    "ProxyElasticLoadBalancer",
                    "DNSName"
                  ]
                },
                "\n",
                "export TARGET_HOST=${IP}\n",
                "export LOGSTASH_HOST=${IP}\n",
                "export CUSTOM_NETWORK_NAME=adop-network\n",
                "export ADOP_SMTP_ENABLED=true\n",
                "export AWS_DEFAULT_REGION=",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "export AWS_VPC_ID=",
                {
                  "Ref": "Vpc"
                },
                "\n",
                "export AWS_VPC_CIDR=",
                {
                  "Fn::GetAtt": [
                    "Vpc",
                    "CidrBlock"
                  ]
                },
                "\n",
                "export AWS_PUBLIC_SUBNET_ID=",
                {
                  "Ref": "PublicSubnet"
                },
                "\n",
                "export AWS_PRIVATE_SUBNET_ID=",
                {
                  "Ref": "PrivateSubnet"
                },
                "\n",
                "export AWS_DEFAULT_RHEL_AMI=",
                {
                  "Fn::FindInMap": [
                    "RegionMap",
                    {
                      "Ref": "AWS::Region"
                    },
                    "RHELAMI"
                  ]
                },
                "\n",
                "export AWS_DEFAULT_CENTOS_AMI=",
                {
                  "Fn::FindInMap": [
                    "RegionMap",
                    {
                      "Ref": "AWS::Region"
                    },
                    "CENTOSAMI"
                  ]
                },
                "\n",
                "export AWS_DEFAULT_AWS_LINUX_AMI=",
                {
                  "Fn::FindInMap": [
                    "RegionMap",
                    {
                      "Ref": "AWS::Region"
                    },
                    "AWSLINUXAMI"
                  ]
                },
                "\n",
                "export AWS_KEY_PAIR=",
                {
                  "Ref": "KeyName"
                },
                "\n",
                "export INITIAL_ADMIN_USER=",
                {
                  "Ref": "AdopUsername"
                },
                "\n",
                "export INITIAL_ADMIN_PASSWORD_PLAIN=",
                {
                  "Ref": "AdopUserPassword"
                },
                "\n",
                "export COMPOSE_OVERRIDES='-f docker-compose.yml -f compose/gitlab/docker-compose.yml -f compose/jenkins-aws-vars/docker-compose.yml -f compose/jenkins-ansible-slave/docker-compose.yml'\n",
                "export VOLUME_OVERRIDES='-f etc/volumes/local/default.yml'\n",
                "export LOGGING_OVERRIDES='-f etc/logging/syslog/default.yml'\n",
                "export ADOP_CLI_USER=",
                {
                  "Ref": "AdopUsername"
                },
                "\n",
                "export ADOP_CLI_PASSWORD=",
                {
                  "Ref": "AdopUserPassword"
                },
                "\n",
                "\"> conf/provider/aws/cloudformation_vars.sh\n",
                "echo \". /adop/adop-docker-compose/conf/provider/aws/cloudformation_vars.sh\" >> ~/.bashrc\n",
                "echo \". /adop/adop-docker-compose/platform.secrets.sh\" >> ~/.bashrc\n",
                "echo \". /adop/adop-docker-compose/env.config.sh\" >> ~/.bashrc\n",
                "echo \"export INITIAL_ADMIN_PASSWORD=$(echo -n $INITIAL_ADMIN_PASSWORD_PLAIN | base64)\" >> ~/.bashrc\n",
                "echo \"export JENKINS_PWD=$(echo -n $PASSWORD_JENKINS | base64)\" >> ~/.bashrc\n",
                "source env.config.sh\n",
                "source conf/provider/aws/cloudformation_vars.sh\n",
                "source credentials.generate.sh\n",
                "docker network create ${CUSTOM_NETWORK_NAME}\n",
                "compose/mail-server/setup_mailserver.sh\n",
                "docker-compose -f compose/mail-server/docker-compose.yml up -d\n",
                "docker-compose -f compose/elk.yml up -d\n",
                "docker-compose ${COMPOSE_OVERRIDES} ${VOLUME_OVERRIDES} pull \n",
                "docker-compose ${COMPOSE_OVERRIDES} ${VOLUME_OVERRIDES} ${LOGGING_OVERRIDES} up -d ldap gitlab jenkins\n",
                "sleep 10\n",
                "docker-compose ${COMPOSE_OVERRIDES} ${VOLUME_OVERRIDES} ${LOGGING_OVERRIDES} up -d\n",
                "./gitlab-load-platform\n",
                "./adop target set -t http://${IP} -u ${ADOP_CLI_USER} -p ${ADOP_CLI_PASSWORD}\n",
                "source ./.adop/target\n",
                "ADOP_WORKSPACE=",
                {
                  "Ref": "AdopWorkspace"
                },
                "\n",
                "if [[ ! -z ${ADOP_WORKSPACE} ]] && [[ ${ADOP_WORKSPACE} != \"None\" ]]; then ",
                "  ./adop workspace -w ${ADOP_WORKSPACE} create -a ${INITIAL_ADMIN_USER}@${LDAP_DOMAIN}; ",
                "  ./adop project -w ${ADOP_WORKSPACE} -p ${ADOP_WORKSPACE}_Project create -a ${INITIAL_ADMIN_USER}@${LDAP_DOMAIN}; ",
                "fi\n",
                "OUTER_PROXY_INTERNAL_IP=",
                {
                  "Fn::GetAtt": [
                    "OuterProxyEC2",
                    "PrivateIp"
                  ]
                },
                "\n",
                "echo \"Deploying Nginx in outer proxy instance - ${OUTER_PROXY_INTERNAL_IP}..\"\n",
                "export DOCKER_HOST=\"tcp://${OUTER_PROXY_INTERNAL_IP}:2377\"\n",
                "docker run --restart=always --name outer-proxy -e TARGET=${IP} -d -p 80:80 accenture/adop-outer-proxy:0.1.0\n",
                "echo \"Sleeping for 30 seconds before cloudformation ends..\"; sleep 30\n",
                "curl -X PUT -H 'Content-Type:' --data-binary '{\"Status\" : \"SUCCESS\",",
                "\"Reason\" : \"ADOP is ready\",",
                "\"UniqueId\" : \"IDAdopCompletion\",",
                "\"Data\" : \"Done\"}' ",
                "\"",
                {
                  "Ref": "AdopWaitConditionHandle"
                },
                "\"\n",
                "\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        }
      },
      "DependsOn": [
        "GlusterServerWaitCondition"
      ]
    },
    "OuterProxySG": {
      "Properties": {
        "GroupDescription": "Nat Outer Proxy Security Group",
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "22",
            "IpProtocol": "tcp",
            "ToPort": "22"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "80",
            "IpProtocol": "tcp",
            "ToPort": "80"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "443",
            "IpProtocol": "tcp",
            "ToPort": "443"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::SecurityGroup",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "5f8a92e2-f223-4168-893e-02e01796aa86"
        }
      }
    },
    "MailServerSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Mail Server Security Group",
        "SecurityGroupIngress": [
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "9025",
            "IpProtocol": "tcp",
            "ToPort": "9025"
          },
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "143",
            "IpProtocol": "tcp",
            "ToPort": "143"
          },
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "587",
            "IpProtocol": "tcp",
            "ToPort": "587"
          },
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "993",
            "IpProtocol": "tcp",
            "ToPort": "993"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a31d4eed-b455-4c7c-8658-aedba20d70b4"
        }
      }
    },
    "ToolsSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Adop Instance Security Group",
        "SecurityGroupIngress": [
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "80",
            "IpProtocol": "tcp",
            "ToPort": "80"
          },
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "22",
            "IpProtocol": "tcp",
            "ToPort": "22"
          },
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "443",
            "IpProtocol": "tcp",
            "ToPort": "443"
          },
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "-1",
            "IpProtocol": "icmp",
            "ToPort": "-1"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "8246d075-3d2a-4ab5-934f-45a154f6eed4"
        }
      }
    },
    "NatWaitCondition": {
      "Type": "AWS::CloudFormation::WaitCondition",
      "Properties": {
        "Handle": {
          "Ref": "NatWaitConditionHandle"
        },
        "Timeout": "1500"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "b3e4116d-b0f6-46a3-a269-224be71ffc07"
        }
      },
      "DependsOn": [
        "NatGateway"
      ]
    },
    "NatWaitConditionHandle": {
      "Type": "AWS::CloudFormation::WaitConditionHandle",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "3dfe2a24-9f1c-4ff9-bfb3-afa9d81013e0"
        }
      }
    },
    "PrivateSubnetPrivateRouteTableAssoc": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable"
        },
        "SubnetId": {
          "Ref": "PrivateSubnet"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "049f94c1-5d6d-4cf8-9f02-03d83e9dde62"
        }
      }
    },
    "DockerApiSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Docker Engine Security Group.",
        "SecurityGroupIngress": [
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
            "FromPort": "2377",
            "IpProtocol": "tcp",
            "ToPort": "2377"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6d3033fd-be1c-4bfe-86cc-bfb6d68cd3d2"
        }
      }
    },
    "NatGateway": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "ElasticIP",
            "AllocationId"
          ]
        },
        "SubnetId": {
          "Ref": "PublicSubnet"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "304ba234-ee5d-4c0a-8e78-6175ee5cd043"
        }
      }
    },
    "ProxyElasticLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "Subnets": [
          {
            "Ref": "PublicSubnet"
          }
        ],
        "Instances": [
          {
            "Ref": "OuterProxyEC2"
          }
        ],
        "Listeners": [
          {
            "LoadBalancerPort": "80",
            "InstancePort": "80",
            "Protocol": "HTTP"
          }
        ],
        "HealthCheck": {
          "Target": "TCP:80",
          "HealthyThreshold": "3",
          "UnhealthyThreshold": "5",
          "Interval": "30",
          "Timeout": "5"
        },
        "SecurityGroups": [
          {
            "Fn::GetAtt": [
              "OuterProxySG",
              "GroupId"
            ]
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "af670eba-ce9c-4a2a-b8a7-781b37be2d2f"
        }
      },
      "DependsOn": [
        "OuterProxyEC2"
      ]
    },
    "GlusterServerEC2": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": 10,
              "VolumeType": "gp2"
            }
          },
          {
            "DeviceName": "/dev/sdb",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": 120,
              "VolumeType": "gp2"
            }
          }
        ],
        "NetworkInterfaces": [
          {
            "AssociatePublicIpAddress": "false",
            "DeleteOnTermination": "true",
            "DeviceIndex": "0",
            "GroupSet": [
              {
                "Ref": "DockerApiSG"
              },
              {
                "Ref": "OuterProxySG"
              },
              {
                "Ref": "AllPortsSG"
              }
            ],
            "SubnetId": {
              "Ref": "PrivateSubnet"
            }
          }
        ],
        "InstanceType": "t2.small",
        "ImageId": {
          "Fn::FindInMap": [
            "RegionMap",
            {
              "Ref": "AWS::Region"
            },
            "CENTOSAMI"
          ]
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "GlusterServer"
                ]
              ]
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "",
                "yum -y install lvm2\n",
                "yum -y install centos-release-gluster\n",
                "yum -y --enablerepo=centos-gluster*-test install glusterfs-server\n",
                "service glusterd start\n",
                "systemctl enable glusterd\n",
                "pvcreate --dataalignment 1280K /dev/xvdb\n",
                "pvdisplay > /tmp/pvdisplay.log\n",
                "vgcreate --physicalextentsize 128K gfs-vg /dev/xvdb\n",
                "lvcreate -l 95%VG -n gfs-thinpool gfs-vg\n",
                "lvcreate -l 1%VG -n gfs-thinpool-meta gfs-vg\n",
                "lvconvert -y --zero n --chunksize 1280K --thinpool gfs-vg/gfs-thinpool --poolmetadata gfs-vg/gfs-thinpool-meta\n",
                "lvdisplay > /tmp/db-lvdisplay.log\n",
                "lvcreate -V 50G -T gfs-vg/gfs-thinpool -n tools-lv\n",
                "mkfs.ext4 /dev/gfs-vg/tools-lv\n",
                "mkdir -p /gfs-tools\n",
                "mount /dev/gfs-vg/tools-lv  /gfs-tools\n",
                "echo \"/dev/gfs-vg/tools-lv  /gfs-tools  ext4  defaults      0 0\" >> /etc/fstab\n",
                "gluster volume create tools-gfs-vol1 $(hostname -i):/gfs-tools/tools-gfs-vol1\n",
                "gluster volume start tools-gfs-vol1\n",
                "curl -X PUT -H 'Content-Type:' --data-binary '{\"Status\" : \"SUCCESS\",",
                "\"Reason\" : \"ADOP is ready\",",
                "\"UniqueId\" : \"IDAdopCompletion\",",
                "\"Data\" : \"Done\"}' ",
                "\"",
                {
                  "Ref": "GlusterServerWaitConditionHandle"
                },
                "\"\n",
                "\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "cfcd380c-f9ba-479e-98e5-203205842bae"
        }
      },
      "DependsOn": [
        "NatWaitCondition"
      ]
    },
    "GlusterServerWaitCondition": {
      "Type": "AWS::CloudFormation::WaitCondition",
      "Properties": {
        "Handle": {
          "Ref": "GlusterServerWaitConditionHandle"
        },
        "Timeout": "1500"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98"
        }
      },
      "DependsOn": [
        "GlusterServerEC2"
      ]
    },
    "GlusterServerWaitConditionHandle": {
      "Type": "AWS::CloudFormation::WaitConditionHandle",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        }
      }
    },
    "AllPortsSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "All Ports Security Group.",
        "SecurityGroupIngress": [
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
			"FromPort": "0",
            "IpProtocol": "tcp",
            "ToPort": "65535"
          },
          {
            "CidrIp": {
              "Fn::GetAtt": [
                "Vpc",
                "CidrBlock"
              ]
            },
			"FromPort": "0",
            "IpProtocol": "udp",
            "ToPort": "65535"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7ff96b56-c797-48fd-9003-334a88d0bd51"
        }
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Designer": {
      "a25e58c0-2ee7-41d4-ab1f-42f4d636c535": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1380,
          "y": 670
        },
        "z": 1,
        "embeds": []
      },
      "a44e677b-c679-482b-929c-f1a7aa112926": {
        "size": {
          "width": 590,
          "height": 390
        },
        "position": {
          "x": 1300,
          "y": 760
        },
        "z": 1,
        "embeds": [
          "7ff96b56-c797-48fd-9003-334a88d0bd51",
          "6d3033fd-be1c-4bfe-86cc-bfb6d68cd3d2",
          "8246d075-3d2a-4ab5-934f-45a154f6eed4",
          "a31d4eed-b455-4c7c-8658-aedba20d70b4",
          "5f8a92e2-f223-4168-893e-02e01796aa86",
          "47a0f538-656e-497c-9a80-fbc052fccd00",
          "c48aeab8-eb45-4a74-a89a-8688260aae5d",
          "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3",
          "4ddb3c75-e8a0-4b89-9744-115cc2a9d1ee"
        ]
      },
      "35cfa4d8-7b76-4317-a01a-96dbf919bd0d": {
        "size": {
          "width": 240,
          "height": 240
        },
        "position": {
          "x": 590,
          "y": 390
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": [
          "eeee439c-93d4-4d5d-904e-8de917cf1f40",
          "cba4c0fc-c175-4f41-88be-bdcd9a25a862",
          "cd66cd71-b482-4f28-92a6-11dc601a5597"
        ]
      },
      "5d410393-db64-4d4b-836d-a23ab8561339": {
        "size": {
          "width": 170,
          "height": 160
        },
        "position": {
          "x": 340,
          "y": 430
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": [
          "655d7159-0e6b-41f6-b58d-d795e5b20e7a"
        ]
      },
      "b35c0812-8292-43d4-aaf9-ec5587d06c6e": {
        "source": {
          "id": "5d410393-db64-4d4b-836d-a23ab8561339"
        },
        "target": {
          "id": "35cfa4d8-7b76-4317-a01a-96dbf919bd0d"
        },
        "z": 2
      },
      "82dcb3af-1538-44be-b9ad-cda2335288f1": {
        "source": {
          "id": "a25e58c0-2ee7-41d4-ab1f-42f4d636c535"
        },
        "target": {
          "id": "a44e677b-c679-482b-929c-f1a7aa112926"
        },
        "z": 1
      },
      "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3": {
        "size": {
          "width": 220,
          "height": 180
        },
        "position": {
          "x": 1530,
          "y": 790
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": [
          "a2c90913-332c-4f4c-a123-63d38abeed7e",
          "304ba234-ee5d-4c0a-8e78-6175ee5cd043"
        ]
      },
      "4ddb3c75-e8a0-4b89-9744-115cc2a9d1ee": {
        "size": {
          "width": 160,
          "height": 150
        },
        "position": {
          "x": 1330,
          "y": 800
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": [
          "cc4ce313-df1f-42d2-bab5-12efccd9dfd9"
        ]
      },
      "49ba56df-a6f9-4eef-a621-d01f453e23d9": {
        "source": {
          "id": "4ddb3c75-e8a0-4b89-9744-115cc2a9d1ee"
        },
        "target": {
          "id": "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3"
        },
        "z": 2
      },
      "cc4ce313-df1f-42d2-bab5-12efccd9dfd9": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1380,
          "y": 850
        },
        "z": 3,
        "parent": "4ddb3c75-e8a0-4b89-9744-115cc2a9d1ee",
        "embeds": [],
        "references": [
          "a25e58c0-2ee7-41d4-ab1f-42f4d636c535"
        ]
      },
      "9476a6df-d58e-42b8-93db-8d04e5f5b7f4": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 880,
          "y": 230
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": []
      },
      "97c64025-438f-4af4-afd1-18baa33f0dbc": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 680,
          "y": 230
        },
        "z": 3,
        "parent": "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3",
        "embeds": [],
        "isrelatedto": [
          "9476a6df-d58e-42b8-93db-8d04e5f5b7f4",
          "0ed6b090-237d-4f57-ad37-f77099070540"
        ]
      },
      "655d7159-0e6b-41f6-b58d-d795e5b20e7a": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 390,
          "y": 480
        },
        "z": 3,
        "parent": "5d410393-db64-4d4b-836d-a23ab8561339",
        "embeds": [],
        "references": [
          "97c64025-438f-4af4-afd1-18baa33f0dbc"
        ]
      },
      "5f8a92e2-f223-4168-893e-02e01796aa86": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1790,
          "y": 770
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": []
      },
      "cd66cd71-b482-4f28-92a6-11dc601a5597": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 620,
          "y": 450
        },
        "z": 3,
        "parent": "35cfa4d8-7b76-4317-a01a-96dbf919bd0d",
        "embeds": [],
        "dependson": [
          "50a0d189-8c47-44b2-8eff-17759eb9c659",
          "97c64025-438f-4af4-afd1-18baa33f0dbc",
          "a0c96e64-00eb-47a4-8b7c-70035ccc71e9"
        ],
        "isrelatedto": [
          "9476a6df-d58e-42b8-93db-8d04e5f5b7f4",
          "a44e677b-c679-482b-929c-f1a7aa112926",
          "5f8a92e2-f223-4168-893e-02e01796aa86",
          "89b96fce-9d10-40a4-9707-28adc03432e7",
          "6378e06e-56df-465c-baa5-1984f0c2ff48",
          "2081c4d8-19c1-42cd-ac1b-f37218066a19"
        ]
      },
      "6378e06e-56df-465c-baa5-1984f0c2ff48": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 880,
          "y": 390
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": []
      },
      "e7511ce7-d6ad-4efa-9a80-071b8b532447": {
        "source": {
          "id": "cd66cd71-b482-4f28-92a6-11dc601a5597"
        },
        "target": {
          "id": "50a0d189-8c47-44b2-8eff-17759eb9c659"
        },
        "z": 4
      },
      "77d8a590-a4b7-4657-ae49-2bace7b74166": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1480,
          "y": 600
        },
        "z": 0,
        "embeds": [],
        "isconnectedto": [
          "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        ],
        "isrelatedto": [
          "a44e677b-c679-482b-929c-f1a7aa112926"
        ]
      },
      "820de39c-9417-4a1d-ad9d-98e027eb1a3f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 600,
          "y": 590
        },
        "z": 3,
        "parent": "35cfa4d8-7b76-4317-a01a-96dbf919bd0d",
        "embeds": [],
        "dependson": [
          "50a0d189-8c47-44b2-8eff-17759eb9c659",
          "97c64025-438f-4af4-afd1-18baa33f0dbc"
        ],
        "isrelatedto": [
          "9476a6df-d58e-42b8-93db-8d04e5f5b7f4",
          "a44e677b-c679-482b-929c-f1a7aa112926",
          "5f8a92e2-f223-4168-893e-02e01796aa86",
          "89b96fce-9d10-40a4-9707-28adc03432e7",
          "6378e06e-56df-465c-baa5-1984f0c2ff48"
        ]
      },
      "a7beba5f-00e5-4d95-b03f-be9fc6d2aab5": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 520,
          "y": 700
        },
        "z": 1,
        "embeds": [],
        "references": [
          "2081c4d8-19c1-42cd-ac1b-f37218066a19"
        ],
        "dependson": [
          "cd66cd71-b482-4f28-92a6-11dc601a5597"
        ]
      },
      "2081c4d8-19c1-42cd-ac1b-f37218066a19": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 610,
          "y": 700
        },
        "z": 1,
        "embeds": []
      },
      "3d85fceb-fe8b-4481-b64f-d6d957976075": {
        "source": {
          "id": "a7beba5f-00e5-4d95-b03f-be9fc6d2aab5"
        },
        "target": {
          "id": "cd66cd71-b482-4f28-92a6-11dc601a5597"
        },
        "z": 11
      },
      "b99d6ff0-701c-486c-b251-dd9f37c3bf91": {
        "source": {
          "id": "50a0d189-8c47-44b2-8eff-17759eb9c659"
        },
        "target": {
          "id": "a7beba5f-00e5-4d95-b03f-be9fc6d2aab5"
        },
        "z": 4
      },
      "cba4c0fc-c175-4f41-88be-bdcd9a25a862": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 730,
          "y": 450
        },
        "z": 3,
        "parent": "35cfa4d8-7b76-4317-a01a-96dbf919bd0d",
        "embeds": [],
        "dependson": [
          "50a0d189-8c47-44b2-8eff-17759eb9c659",
          "97c64025-438f-4af4-afd1-18baa33f0dbc",
          "a0c96e64-00eb-47a4-8b7c-70035ccc71e9"
        ],
        "isrelatedto": [
          "9476a6df-d58e-42b8-93db-8d04e5f5b7f4",
          "a44e677b-c679-482b-929c-f1a7aa112926",
          "5f8a92e2-f223-4168-893e-02e01796aa86",
          "89b96fce-9d10-40a4-9707-28adc03432e7",
          "6378e06e-56df-465c-baa5-1984f0c2ff48",
          "2081c4d8-19c1-42cd-ac1b-f37218066a19",
          "4639eafb-f924-47cc-9b96-2e3d5c363e1d"
        ]
      },
      "007d682c-145c-42ac-a10f-dbb3c791ca22": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 990,
          "y": 540
        },
        "z": 1,
        "embeds": [],
        "references": [
          "4639eafb-f924-47cc-9b96-2e3d5c363e1d"
        ],
        "dependson": [
          "cba4c0fc-c175-4f41-88be-bdcd9a25a862"
        ]
      },
      "4639eafb-f924-47cc-9b96-2e3d5c363e1d": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 990,
          "y": 450
        },
        "z": 1,
        "embeds": []
      },
      "4f373403-1ec4-4a33-9390-f1e9c3e48b03": {
        "source": {
          "id": "007d682c-145c-42ac-a10f-dbb3c791ca22"
        },
        "target": {
          "id": "cba4c0fc-c175-4f41-88be-bdcd9a25a862"
        },
        "z": 11
      },
      "ae7640e6-2e2a-4304-b19a-3c52707580c9": {
        "source": {
          "id": "50a0d189-8c47-44b2-8eff-17759eb9c659"
        },
        "target": {
          "id": "007d682c-145c-42ac-a10f-dbb3c791ca22"
        },
        "z": 11
      },
      "a0c96e64-00eb-47a4-8b7c-70035ccc71e9": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1010,
          "y": 210
        },
        "z": 1,
        "embeds": [],
        "references": [
          "0ed6b090-237d-4f57-ad37-f77099070540"
        ],
        "dependson": [
          "97c64025-438f-4af4-afd1-18baa33f0dbc"
        ]
      },
      "0ed6b090-237d-4f57-ad37-f77099070540": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1010,
          "y": 290
        },
        "z": 0,
        "embeds": []
      },
      "47b1dfa3-3434-4265-96f4-25a6ef11964d": {
        "source": {
          "id": "a0c96e64-00eb-47a4-8b7c-70035ccc71e9"
        },
        "target": {
          "id": "97c64025-438f-4af4-afd1-18baa33f0dbc"
        },
        "z": 11
      },
      "80eb011b-5d3f-4e10-9728-392827cc4a80": {
        "source": {
          "id": "cba4c0fc-c175-4f41-88be-bdcd9a25a862"
        },
        "target": {
          "id": "a0c96e64-00eb-47a4-8b7c-70035ccc71e9"
        },
        "z": 4
      },
      "f55b605c-abf9-4903-8caf-d9b638f1e919": {
        "source": {
          "id": "cd66cd71-b482-4f28-92a6-11dc601a5597"
        },
        "target": {
          "id": "a0c96e64-00eb-47a4-8b7c-70035ccc71e9"
        },
        "z": 4
      },
      "eeee439c-93d4-4d5d-904e-8de917cf1f40": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 730,
          "y": 540
        },
        "z": 3,
        "parent": "35cfa4d8-7b76-4317-a01a-96dbf919bd0d",
        "embeds": [],
        "dependson": [
          "a0c96e64-00eb-47a4-8b7c-70035ccc71e9"
        ],
        "isrelatedto": [
          "6378e06e-56df-465c-baa5-1984f0c2ff48",
          "7d14e476-f68d-4015-9068-5b65c9d34560"
        ]
      },
      "68a71f69-06b6-44b1-a4e7-97ca8995297f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 720,
          "y": 700
        },
        "z": 0,
        "embeds": [],
        "references": [
          "7d14e476-f68d-4015-9068-5b65c9d34560"
        ],
        "dependson": [
          "a0c96e64-00eb-47a4-8b7c-70035ccc71e9",
          "eeee439c-93d4-4d5d-904e-8de917cf1f40"
        ]
      },
      "7d14e476-f68d-4015-9068-5b65c9d34560": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 810,
          "y": 700
        },
        "z": 0,
        "embeds": []
      },
      "0eef5043-0727-47d5-8591-648eaf4ca05a": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1650,
          "y": 1160
        },
        "z": 0,
        "embeds": [],
        "references": [
          "7934e36f-378a-4447-aa93-674ae8a35be6"
        ],
        "dependson": [
          "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        ]
      },
      "7934e36f-378a-4447-aa93-674ae8a35be6": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1550,
          "y": 1160
        },
        "z": 1,
        "embeds": []
      },
      "a2c90913-332c-4f4c-a123-63d38abeed7e": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1660,
          "y": 830
        },
        "z": 3,
        "parent": "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3",
        "embeds": [],
        "isrelatedto": [
          "5f8a92e2-f223-4168-893e-02e01796aa86",
          "3dfe2a24-9f1c-4ff9-bfb3-afa9d81013e0",
          "6d3033fd-be1c-4bfe-86cc-bfb6d68cd3d2"
        ]
      },
      "c48aeab8-eb45-4a74-a89a-8688260aae5d": {
        "size": {
          "width": 160,
          "height": 140
        },
        "position": {
          "x": 1330,
          "y": 1000
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": [
          "0a40d0ca-3581-4835-9597-e946ea1df989"
        ]
      },
      "0a40d0ca-3581-4835-9597-e946ea1df989": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1380,
          "y": 1040
        },
        "z": 3,
        "parent": "c48aeab8-eb45-4a74-a89a-8688260aae5d",
        "embeds": [],
        "isrelatedto": [
          "304ba234-ee5d-4c0a-8e78-6175ee5cd043"
        ]
      },
      "47a0f538-656e-497c-9a80-fbc052fccd00": {
        "size": {
          "width": 220,
          "height": 140
        },
        "position": {
          "x": 1530,
          "y": 1000
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": [
          "cfcd380c-f9ba-479e-98e5-203205842bae",
          "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        ]
      },
      "7b45ae17-bef2-4fd5-a5cd-58888c87753d": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1550,
          "y": 1040
        },
        "z": 3,
        "parent": "47a0f538-656e-497c-9a80-fbc052fccd00",
        "embeds": [],
        "dependson": [
          "23157f6a-c599-49d1-b672-7c8661e36d98"
        ],
        "isrelatedto": [
          "8246d075-3d2a-4ab5-934f-45a154f6eed4",
          "a31d4eed-b455-4c7c-8658-aedba20d70b4",
          "a2c90913-332c-4f4c-a123-63d38abeed7e",
          "a44e677b-c679-482b-929c-f1a7aa112926",
          "7934e36f-378a-4447-aa93-674ae8a35be6",
          "6d3033fd-be1c-4bfe-86cc-bfb6d68cd3d2",
          "af670eba-ce9c-4a2a-b8a7-781b37be2d2f",
          "cfcd380c-f9ba-479e-98e5-203205842bae",
          "7ff96b56-c797-48fd-9003-334a88d0bd51"
        ]
      },
      "8246d075-3d2a-4ab5-934f-45a154f6eed4": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1790,
          "y": 1010
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": []
      },
      "a31d4eed-b455-4c7c-8658-aedba20d70b4": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1790,
          "y": 1080
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": []
      },
      "9e0ae4bd-010f-45cf-8789-3a897dbc7261": {
        "source": {
          "id": "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        },
        "target": {
          "id": "a2c90913-332c-4f4c-a123-63d38abeed7e"
        },
        "z": 4
      },
      "049f94c1-5d6d-4cf8-9f02-03d83e9dde62": {
        "source": {
          "id": "c48aeab8-eb45-4a74-a89a-8688260aae5d"
        },
        "target": {
          "id": "47a0f538-656e-497c-9a80-fbc052fccd00"
        },
        "z": 2
      },
      "b3e4116d-b0f6-46a3-a269-224be71ffc07": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1560,
          "y": 600
        },
        "z": 0,
        "embeds": [],
        "references": [
          "3dfe2a24-9f1c-4ff9-bfb3-afa9d81013e0"
        ],
        "dependson": [
          "a2c90913-332c-4f4c-a123-63d38abeed7e",
          "304ba234-ee5d-4c0a-8e78-6175ee5cd043"
        ]
      },
      "3dfe2a24-9f1c-4ff9-bfb3-afa9d81013e0": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1660,
          "y": 600
        },
        "z": 0,
        "embeds": []
      },
      "daf4668d-3e47-43de-9240-b7231f6dd143": {
        "source": {
          "id": "b3e4116d-b0f6-46a3-a269-224be71ffc07"
        },
        "target": {
          "id": "a2c90913-332c-4f4c-a123-63d38abeed7e"
        },
        "z": 11
      },
      "dad8c234-e53d-4d8b-bfbf-109d8b772223": {
        "source": {
          "id": "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        },
        "target": {
          "id": "b3e4116d-b0f6-46a3-a269-224be71ffc07"
        },
        "z": 11
      },
      "14a3f198-dd8b-4059-9b04-eb35260974a5": {
        "source": {
          "id": "0eef5043-0727-47d5-8591-648eaf4ca05a"
        },
        "target": {
          "id": "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        },
        "z": 12
      },
      "61dc1fce-adbb-4784-b958-6851664ebe5e": {
        "source": {
          "id": "a2c90913-332c-4f4c-a123-63d38abeed7e"
        },
        "target": {
          "id": "82dcb3af-1538-44be-b9ad-cda2335288f1"
        },
        "z": 11
      },
      "d165c9bd-38f6-4e2b-aea9-f1fa5e855763": {
        "source": {
          "id": "7b45ae17-bef2-4fd5-a5cd-58888c87753d",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(5) circle:nth-child(1)     ",
          "port": "AWS::DependencyLink-*"
        },
        "target": {
          "id": "b3e4116d-b0f6-46a3-a269-224be71ffc07"
        },
        "z": 12
      },
      "43968747-a691-43b3-ba51-4d43cb902b8e": {
        "source": {
          "id": "0eef5043-0727-47d5-8591-648eaf4ca05a"
        },
        "target": {
          "id": "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        },
        "z": 11
      },
      "6d3033fd-be1c-4bfe-86cc-bfb6d68cd3d2": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1790,
          "y": 840
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": []
      },
      "304ba234-ee5d-4c0a-8e78-6175ee5cd043": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1570,
          "y": 830
        },
        "z": 3,
        "parent": "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3",
        "embeds": [],
        "isrelatedto": [
          "77d8a590-a4b7-4657-ae49-2bace7b74166"
        ]
      },
      "af670eba-ce9c-4a2a-b8a7-781b37be2d2f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1790,
          "y": 670
        },
        "z": 0,
        "embeds": [],
        "isconnectedto": [
          "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3",
          "a2c90913-332c-4f4c-a123-63d38abeed7e"
        ],
        "ismemberof": [
          "5f8a92e2-f223-4168-893e-02e01796aa86"
        ],
        "dependson": [
          "a2c90913-332c-4f4c-a123-63d38abeed7e"
        ],
        "isrelatedto": [
          "869aca7e-e10e-4b3f-9bfd-86e5ff3a00e3"
        ]
      },
      "a5852fc1-dceb-4ea5-8903-c1df3fbef054": {
        "source": {
          "id": "af670eba-ce9c-4a2a-b8a7-781b37be2d2f"
        },
        "target": {
          "id": "a2c90913-332c-4f4c-a123-63d38abeed7e"
        },
        "z": 11
      },
      "cfcd380c-f9ba-479e-98e5-203205842bae": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1650,
          "y": 1040
        },
        "z": 3,
        "parent": "47a0f538-656e-497c-9a80-fbc052fccd00",
        "embeds": [],
        "dependson": [
          "b3e4116d-b0f6-46a3-a269-224be71ffc07"
        ],
        "isrelatedto": [
          "5f8a92e2-f223-4168-893e-02e01796aa86",
          "6d3033fd-be1c-4bfe-86cc-bfb6d68cd3d2",
          "1a87bff9-8762-4dad-9419-ac8210f61260"
        ]
      },
      "23157f6a-c599-49d1-b672-7c8661e36d98": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1740,
          "y": 1160
        },
        "z": 0,
        "embeds": [],
        "references": [
          "1a87bff9-8762-4dad-9419-ac8210f61260"
        ],
        "dependson": [
          "cfcd380c-f9ba-479e-98e5-203205842bae"
        ]
      },
      "1a87bff9-8762-4dad-9419-ac8210f61260": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1840,
          "y": 1160
        },
        "z": 0,
        "embeds": []
      },
      "b864b482-1aa0-4677-b1a9-e8f9dbb1df9e": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98"
        },
        "target": {
          "id": "cfcd380c-f9ba-479e-98e5-203205842bae"
        },
        "z": 11
      },
      "366318e2-209f-470e-a5f7-47831efe5b56": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(1) circle:nth-child(1)     ",
          "port": "AWS::RefLink-AWS::CloudFormation::WaitConditionHandle-Handle"
        },
        "target": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        },
        "z": 12
      },
      "4f0b2b46-c03a-4bc3-bd24-1a1205dc29d4": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(1) circle:nth-child(1)     ",
          "port": "AWS::RefLink-AWS::CloudFormation::WaitConditionHandle-Handle"
        },
        "target": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        },
        "z": 12
      },
      "c8399e42-2dd3-4e48-be97-72d0e0c67a13": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(1) circle:nth-child(1)     ",
          "port": "AWS::RefLink-AWS::CloudFormation::WaitConditionHandle-Handle"
        },
        "target": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        },
        "z": 12
      },
      "fe7f2e15-a974-4e1c-a114-676ded957e1f": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(1) circle:nth-child(1)     ",
          "port": "AWS::RefLink-AWS::CloudFormation::WaitConditionHandle-Handle"
        },
        "target": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        },
        "z": 12
      },
      "cec0426d-1bc8-46ee-9027-c588231dc4f9": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(1) circle:nth-child(1)     ",
          "port": "AWS::RefLink-AWS::CloudFormation::WaitConditionHandle-Handle"
        },
        "target": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        },
        "z": 12
      },
      "c2200cfc-a30a-4b7d-b957-db443c43c754": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(1) circle:nth-child(1)     ",
          "port": "AWS::RefLink-AWS::CloudFormation::WaitConditionHandle-Handle"
        },
        "target": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        },
        "z": 12
      },
      "750d3ca7-ae95-4f60-b12b-0233c881bf5f": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(1) circle:nth-child(1)     ",
          "port": "AWS::RefLink-AWS::CloudFormation::WaitConditionHandle-Handle"
        },
        "target": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        },
        "z": 12
      },
      "fd12feae-8933-4ca7-90ef-2287efb73874": {
        "source": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(1) circle:nth-child(1)     ",
          "port": "AWS::RefLink-AWS::CloudFormation::WaitConditionHandle-Handle"
        },
        "target": {
          "id": "1a87bff9-8762-4dad-9419-ac8210f61260"
        },
        "z": 12
      },
      "eb7ee28a-d4db-4836-afcd-aab2eaa3b0a7": {
        "source": {
          "id": "cfcd380c-f9ba-479e-98e5-203205842bae"
        },
        "target": {
          "id": "b3e4116d-b0f6-46a3-a269-224be71ffc07"
        },
        "z": 11
      },
      "90cb1b27-ce4f-4a84-b770-ec063ca03113": {
        "source": {
          "id": "7b45ae17-bef2-4fd5-a5cd-58888c87753d"
        },
        "target": {
          "id": "23157f6a-c599-49d1-b672-7c8661e36d98"
        },
        "z": 11
      },
      "a9ef6310-2e36-4472-abe0-b035e60813be": {
        "source": {
          "id": "cfcd380c-f9ba-479e-98e5-203205842bae",
          "selector": "g:nth-child(1) g:nth-child(4) g:nth-child(5) circle:nth-child(1)     ",
          "port": "AWS::DependencyLink-*"
        },
        "target": {
          "id": "b3e4116d-b0f6-46a3-a269-224be71ffc07"
        },
        "z": 12
      },
      "7ff96b56-c797-48fd-9003-334a88d0bd51": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1790,
          "y": 920
        },
        "z": 2,
        "parent": "a44e677b-c679-482b-929c-f1a7aa112926",
        "embeds": []
      }
    }
  }
}